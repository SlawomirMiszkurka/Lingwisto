<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Czat</title>
</head>
<body>
    <div id="app" class="container">
        <h2>{{ chatTitle }}</h2>
        <div id="chat-messages">
            <div v-for="(message, index) in chatMessages" :key="index">
                <p>{{ message.sender }}: {{ message.content }}</p>
            </div>
        </div>
        <input type="file" accept="image/*" id="image-input" @change="captureImage">
        <button @click="sendMessage">Wyślij</button>
        <div id="loading" class="loading" v-if="loading">Ładowanie...</div>
        <div id="error-msg" style="color: red;">{{ errorMessage }}</div>
    </div>

    <!-- Dodaj tutaj skrypty Vue.js i Firebase -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
        // Konfiguracja Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCaGP-ADlaVgOGXoyoePebFimn7Xy7MsWw",
            authDomain: "project-af0f5.firebaseapp.com",
            databaseURL: "https://project-af0f5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "project-af0f5",
            storageBucket: "project-af0f5.appspot.com",
            messagingSenderId: "82817780469",
            appId: "1:82817780469:web:45c3cb6de62a9f279753bc"
        };

        // Inicjalizacja Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = app.database();
        const storage = app.storage();

        new Vue({
            el: '#app',
            data() {
                return {
                    chatTitle: '',
                    chatMessages: [],
                    errorMessage: '',
                    loading: false
                };
            },
            created() {
                const friendId = this.getParameterByName('friendId');
                const friendName = this.getParameterByName('friendName');
                this.chatTitle = `Czat z ${friendName}`;

                const chatRef = database.ref(`chats/${friendId}`);
                chatRef.on("value", (snapshot) => {
                    const chatMessages = snapshot.val();
                    this.chatMessages = Object.values(chatMessages);
                });
            },
            methods: {
                getParameterByName(name, url) {
                    if (!url) url = window.location.href;
                    name = name.replace(/[\[\]]/g, "\\$&");
                    const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                        results = regex.exec(url);
                    if (!results) return null;
                    if (!results[2]) return '';
                    return decodeURIComponent(results[2].replace(/\+/g, " "));
                },
                captureImage(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.loading = true;
                        const friendId = this.getParameterByName('friendId');
                        const storageRef = storage.ref();
                        const imageRef = storageRef.child(`images/${friendId}/${file.name}`);
                        imageRef.put(file).then((snapshot) => {
                            imageRef.getDownloadURL().then((downloadURL) => {
                                const newMessageRef = database.ref(`chats/${friendId}`).push();
                                newMessageRef.set({
                                    sender: 'Ja', // Tutaj należy dodać nazwę użytkownika
                                    content: downloadURL
                                });
                                this.loading = false;
                            });
                        }).catch((error) => {
                            this.errorMessage = "Błąd przesyłania zdjęcia: " + error.message;
                            this.loading = false;
                        });
                    }
                },
                sendMessage() {
                    const messageInput = document.getElementById('message-input');
                    const messageContent = messageInput.value.trim();
                    if (messageContent !== '') {
                        const friendId = this.getParameterByName('friendId');
                        const newMessageRef = database.ref(`chats/${friendId}`).push();
                        newMessageRef.set({
                            sender: 'Ja', // Tutaj należy dodać nazwę użytkownika
                            content: messageContent
                        });
                        messageInput.value = '';
                    }
                }
            }
        });
    </script>
</body>
</html>
